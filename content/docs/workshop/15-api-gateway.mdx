---
title: "API Gateway HTTP API"
description: "Expose the Beetroot API Lambda using an HTTP API in API Gateway with routes, CORS, and a curl test."
---

import { Callout } from "fumadocs-ui/components/callout";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";
import { Steps, Step } from "fumadocs-ui/components/steps";

## Goal

By the end of this phase, you'll have a public HTTP endpoint (API Gateway) that calls your API Lambda.

Your React app will be able to call:

```txt
GET /persons
GET /persons/{personId}/photos
```

<Callout type="info" title="Mental model: API Gateway vs Lambda">
  <b>API Gateway</b> is the “front door” (public URL + routing + CORS).{" "}
  <b>Lambda</b> is the “brain” (runs your Python code and returns JSON).
</Callout>

## Prerequisites

- Lambda: <code>beetroot-api</code> (from the previous phase)

<Callout type="tip" title="Region reminder">
  Create the HTTP API in the same region as your Lambda (us-east-1), otherwise
  the integration won't show up.
</Callout>

## Step 1: Create an HTTP API

<Steps>
  <Step>
    ### Create the API

1. Open <b>API Gateway</b>
2. Click <b>Create API</b>
3. Choose <b>HTTP API</b> → <b>Build</b>

<Callout type="info" title="Why HTTP API (not REST API)?">
  HTTP API is simpler and cheaper for basic GET routes. It's a great fit for
  this workshop.
</Callout>

  </Step>

  <Step>
    ### Add the Lambda integration

In the setup flow:

1. API Name: `BeetrootAPIGateway`
2. Under <b>Integrations</b>, select <b>Lambda</b>
3. Region: <b>us-east-1</b>
4. Choose your Lambda: <code>beetroot-api</code>
5. Next

<Callout type="tip" title="What “integration” means">
  An integration is just “what should run when someone hits this route?”. Here,
  the answer is your Lambda.
</Callout>

  </Step>

  <Step>
    ### Define routes

| Method  | Resource Path                |
| ------- | ---------------------------- |
| GET     | `/persons`                   |
| OPTIONS | `/persons/{personId}/photos` |

For both routes, choose the same integration: <code>beetroot-api</code>.

<Callout type="info" title="Why both routes use the same Lambda">
  Your Lambda already routes based on <code>method</code> and <code>path</code>.
  API Gateway just forwards the request.
</Callout>

  </Step>

  <Step>
    ### Enable CORS (important for React)

In <b>API settings → Develop → CORS</b>:

- <b>Access-Control-Allow-Origin:</b> <code>*</code> (dev only)
- <b>Access-Control-Allow-Headers:</b> <code>content-type</code>
- <b>Access-Control-Allow-Methods:</b> <code>GET, OPTIONS</code>

<Callout type="warning" title="CORS note">
  <code>*</code> is fine for development. In production, set this to your real
  frontend domain.
</Callout>

  </Step>

  <Step>
    ### Stage + deploy

HTTP APIs typically use the <code>$default</code> stage with <b>Auto-deploy</b>. So, there's no
need to click on the **Deploy** button.

<Callout type="tip" title="What a stage is">
  A stage is a deployed version of your API. <code>$default</code> keeps things
  simple for this workshop.
</Callout>

  </Step>
</Steps>

## Step 2: Confirm Lambda invoke permission

API Gateway must be allowed to invoke your Lambda.
Usually the console adds this automatically, but you can verify by 2 ways.

First, open the `beetroot-api` lambda function.

1. You should see **API Gateway** connected to the lambda function, which gets executed on each request.

![beetroot-api function overview with API Gateway](/images/architecture/beetroot-api-function-overview.png)

2. Go to <b>Configuration → Permissions → Resource-based policy statements</b> and look for a statement mentioning <code>apigateway.amazonaws.com</code>

<Callout type="info" title="If the permission is missing">
  If API Gateway can't invoke Lambda, you'll usually get <b>403</b> or{" "}
  <b>500</b>. We'll cover quick fixes in Common issues.
</Callout>

## Step 3: Get Invoke URL and test

Go to:

- API Gateway → `BeetrootAPIGateway` → <b>Stages</b> → <code>$default</code>
- Copy the <b>Invoke URL</b>

## Common issues

<Tabs items={["403 Forbidden", "500 Internal Server Error", "CORS in browser only"]} groupId="phase13b-issues" persist> <Tab value="403 Forbidden">
Most common causes:

- API Gateway does not have permission to invoke the Lambda
- You're calling the wrong URL/stage

Check:

- Lambda → <code>beetroot-api</code> → <b>Permissions</b> includes <code>apigateway.amazonaws.com</code>
- API Gateway → <b>Stages</b> → using the correct <b>Invoke URL</b>

</Tab>

  <Tab value="500 Internal Server Error">
    This usually means the Lambda crashed. Check:

- CloudWatch logs: <code>/aws/lambda/beetroot-api</code>
- Common causes:
  - Missing env vars (table names)
  - JSON serialization errors (Decimals) if the previous phase fix wasn't applied

</Tab>

  <Tab value="CORS in browser only">
    If <code>curl</code> works but the browser fails:

- Ensure CORS is enabled in **API Gateway** (Allowed origins/methods/headers)
- Ensure your Lambda response includes CORS headers (we added them in <code>\_resp</code>)

</Tab>
</Tabs>

## Test

### Route 1: list persons

<Tabs items={["cURL", "Response"]} groupId="list-persons-req-resp" persist> <Tab value="cURL">

```bash
curl -X GET "<INVOKE_URL>/persons"
```

  </Tab>
  <Tab value="Response">

```json
{
  "persons": [
    {
      "photoCount": 4,
      "createdAt": "2025-12-21T08:16:04.864553+00:00",
      "personId": "a5a48144-1b50-4eca-9b93-65cf88527266",
      "repThumbKey": "faces-thumbs/a5a48144-1b50-4eca-9b93-65cf88527266/9db7214ecc27b77b20eb_face_1.jpg"
    },
    ...
  ]
}
```

  </Tab>
</Tabs>

### Route 2: photos for one person

Copy one <code>personId</code> from the <code>/persons</code> response.

<Tabs items={["cURL", "Response"]} groupId="photos-per-person-req-resp" persist> <Tab value="cURL">

```bash
curl -X GET "<INVOKE_URL>/persons/{personId}/photos"
```

  </Tab>
  <Tab value="Response">

```json
{
  "personId": "a5a48144-1b50-4eca-9b93-65cf88527266",
  "photos": [
    {
      "photoId": "4fcae858bfb8d5e935bd",
      "photoBucket": "photo-clone-raw",
      "photoKey": "photos-raw/r2h21.jpg",
      "thumbKey": null
    },
    {
      "photoId": "930719d43b6ebef54c53",
      "photoBucket": "photo-clone-raw",
      "photoKey": "photos-raw/r2h1.jpg",
      "thumbKey": null
    },
    ...
  ]
}
```

  </Tab>
</Tabs>

<Callout type="tip" title="What “success” looks like">
  You should get JSON back with status code `200` (and not <code>403</code> /{" "}
  <code>500</code>). If <code>/persons</code> returns an empty list, it usually
  means your Persons table is empty (upload more photos first).
</Callout>
